name: CI

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  terraform:
    name: Terraform fmt + validate
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: latest

      - name: Terraform fmt check
        run: terraform fmt -check -recursive

      # Validate each env (add prod later if you have it)
      - name: Terraform validate (dev)
        working-directory: infra/envs/dev
        run: |
          terraform init -backend=false
          terraform validate

  k8s:
    name: Kustomize build + dry-run + kubeconform
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -Ls https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          sudo install -m 0755 kubectl /usr/local/bin/kubectl
          kubectl version --client

      - name: Install kubeconform
        run: |
          curl -L -o /tmp/kubeconform.tar.gz \
            https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz
          tar -xzf /tmp/kubeconform.tar.gz -C /tmp kubeconform
          sudo install -m 0755 /tmp/kubeconform /usr/local/bin/kubeconform
          kubeconform -v

      - name: Kustomize render (dev/preprod/prod)
        run: |
          kubectl kustomize apps/overlays/dev >/dev/null
          kubectl kustomize apps/overlays/preprod >/dev/null
          kubectl kustomize apps/overlays/prod >/dev/null

      - name: kubectl dry-run (dev/preprod/prod)
  run: |
    kubectl apply --dry-run=client --validate=false -k apps/overlays/dev
    kubectl apply --dry-run=client --validate=false -k apps/overlays/preprod
  kubectl apply --dry-run=client --validate=false -k apps/overlays/prod

      - name: kubeconform strict schema (dev/preprod/prod)
        run: |
          kubectl kustomize apps/overlays/dev | kubeconform -strict -ignore-missing-schemas
          kubectl kustomize apps/overlays/preprod | kubeconform -strict -ignore-missing-schemas
          kubectl kustomize apps/overlays/prod | kubeconform -strict -ignore-missing-schemas
